# ğŸ¯ GuÃ­a de Arquitectura y Patrones - Plantilla Backend Express + TypeScript

Esta plantilla sigue una **Arquitectura en Capas (Layered Architecture)** tambiÃ©n conocida como **Controller-Service-Repository Pattern**.

## ğŸ“ Arquitectura del Proyecto

### Flujo de Datos
```
HTTP Request â†’ Routes â†’ Middleware â†’ Controller â†’ Service â†’ Repository â†’ Database
```

### Estructura de Carpetas
```
src/
â”œâ”€â”€ config/          # Configuraciones (Prisma, JWT, env)
â”œâ”€â”€ controllers/     # Controladores HTTP (manejan req/res)
â”œâ”€â”€ services/        # LÃ³gica de negocio (reglas de negocio)
â”œâ”€â”€ repositories/    # Acceso a datos (queries Prisma)
â”œâ”€â”€ models/          # Tipos TypeScript, DTOs, interfaces
â”œâ”€â”€ routes/          # DefiniciÃ³n de rutas (solo routing)
â”œâ”€â”€ middleware/      # Middlewares (auth, error handling)
â”œâ”€â”€ utils/           # Utilidades y helpers
â”œâ”€â”€ types/           # Tipos globales TypeScript
â”œâ”€â”€ constants/       # Constantes (mensajes, cÃ³digos)
â””â”€â”€ server.ts        # Punto de entrada
```

## ğŸ”„ PatrÃ³n de Trabajo

### 1. Crear una Nueva Feature (Ejemplo: Productos)

#### Paso 1: Definir el Modelo en Prisma
```prisma
// prisma/schema.prisma
model Product {
  id          Int      @id @default(autoincrement())
  name        String
  price       Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
```

#### Paso 2: Crear MigraciÃ³n
```bash
npm run prisma:migrate
# Nombre: create_product_table
```

#### Paso 3: Crear Tipos/Modelos
```typescript
// src/models/Product.model.ts
export interface CreateProductInput {
  name: string
  price: number
}
```

#### Paso 4: Crear Repository
```typescript
// src/repositories/Product.repository.ts
export class ProductRepository {
  async findAll() { ... }
  async create(data: CreateProductInput) { ... }
}
```

#### Paso 5: Crear Service
```typescript
// src/services/Product.service.ts
export class ProductService {
  async getAllProducts() { ... }
  async createProduct(data: CreateProductInput) { ... }
}
```

#### Paso 6: Crear Controller
```typescript
// src/controllers/Product.controller.ts
export class ProductController {
  async getAll(req: Request, res: Response) { ... }
  async create(req: Request, res: Response) { ... }
}
```

#### Paso 7: Crear Rutas
```typescript
// src/routes/products.ts
router.get('/', controller.getAll.bind(controller))
router.post('/', authenticate, controller.create.bind(controller))
```

#### Paso 8: Registrar Rutas en server.ts
```typescript
app.use('/api/v1/products', productRouter)
```

#### Paso 9: Agregar a la ColecciÃ³n de Postman
1. Abre `docs/api/back-end.postman_collection.json` en Postman
2. Agrega las nuevas requests en la carpeta correspondiente
3. Configura mÃ©todo, URL, headers y body segÃºn la ruta
4. Exporta y reemplaza el archivo JSON
5. Ver `docs/api/README.md` para mÃ¡s detalles

## ğŸ“‹ Reglas de las Capas

### Routes
- âœ… Solo define endpoints y conecta con controllers
- âŒ NO contiene lÃ³gica de negocio
- âŒ NO accede a la base de datos

### Controllers
- âœ… Recibe req/res, extrae datos, llama a Services
- âœ… Formatea respuestas HTTP
- âŒ NO contiene lÃ³gica de negocio
- âŒ NO accede directamente a la base de datos

### Services
- âœ… Contiene toda la lÃ³gica de negocio
- âœ… Valida datos de entrada
- âœ… Orquesta operaciones entre repositories
- âŒ NO conoce detalles de HTTP (req/res)
- âŒ NO accede directamente a la base de datos

### Repositories
- âœ… Ejecuta queries de Prisma
- âœ… Abstrae acceso a la base de datos
- âŒ NO contiene lÃ³gica de negocio
- âŒ NO valida datos (eso es del Service)

## ğŸ” AutenticaciÃ³n

### Rutas Protegidas
```typescript
import { authenticate } from '../middleware/auth.middleware'

router.post('/protected', authenticate, controller.create)
```

### Obtener Usuario Autenticado
```typescript
const userId = (req as AuthenticatedRequest).user?.id
```

## ğŸ—„ï¸ Base de Datos

### Crear Nueva Tabla
1. Agregar modelo en `prisma/schema.prisma`
2. Ejecutar: `npm run prisma:migrate`
3. Nombre descriptivo: `create_product_table`

### Modificar Tabla Existente
1. Modificar modelo en `prisma/schema.prisma`
2. Ejecutar: `npm run prisma:migrate`
3. Nombre descriptivo: `add_price_to_product`

## ğŸ“ Convenciones de CÃ³digo

### Nombres de Archivos
- Controllers: `*.controller.ts`
- Services: `*.service.ts`
- Repositories: `*.repository.ts`
- Models: `*.model.ts`

### Idioma de Mensajes
- **TODOS** los mensajes de respuesta de la API deben estar en **ESPAÃ‘OL**
- Esto incluye:
  - Mensajes en `constants/index.ts` (HTTP_MESSAGES)
  - Mensajes hardcodeados en controllers
  - Mensajes de error en services
  - Mensajes en middlewares (auth, error, etc.)
  - Mensajes de validaciÃ³n
- Los mensajes deben ser claros, profesionales y en espaÃ±ol neutro

### Estructura de Respuestas API
```typescript
{
  success: true | false,
  message: "OperaciÃ³n completada exitosamente",
  data: { ... },
  error?: "..."
}
```

**IMPORTANTE:** Todos los mensajes de respuesta (message y error) deben estar en **ESPAÃ‘OL**.

### Manejo de Errores
- Services lanzan errores con `statusCode`
- Controllers capturan y formatean respuestas HTTP
- Error middleware maneja errores no capturados

## ğŸš€ Comandos Ãštiles

```bash
# Desarrollo
npm run dev                    # Iniciar servidor
npm run prisma:migrate         # Crear y aplicar migraciÃ³n
npm run prisma:studio          # Abrir Prisma Studio
npm run prisma:generate        # Regenerar Prisma Client

# ProducciÃ³n
npm run prisma:migrate:deploy  # Aplicar migraciones pendientes
```

## ğŸ“® ColecciÃ³n de Postman

### Mantener la ColecciÃ³n Actualizada

**IMPORTANTE:** Cuando crees una nueva API, DEBES agregarla a la colecciÃ³n de Postman.

1. **UbicaciÃ³n**: `docs/api/back-end.postman_collection.json`

2. **Al crear una nueva ruta**:
   - Abre la colecciÃ³n en Postman
   - Agrega la nueva request en la carpeta correspondiente (Auth, Users, etc.)
   - Configura:
     - MÃ©todo HTTP (GET, POST, PUT, DELETE)
     - URL: `{{base_url}}/api/v1/[ruta]`
     - Headers: `Authorization: Bearer {{access_token}}` si requiere autenticaciÃ³n
     - Body: Ejemplo JSON con los campos requeridos
     - Description: DocumentaciÃ³n del endpoint
   - Si es login/register/refresh, agrega Tests para guardar tokens automÃ¡ticamente
   - Exporta y reemplaza el archivo JSON

3. **Estructura de la colecciÃ³n**:
   ```
   Backend Express + TypeScript
   â”œâ”€â”€ Health Check
   â”œâ”€â”€ Authentication
   â”‚   â”œâ”€â”€ Register
   â”‚   â”œâ”€â”€ Login
   â”‚   â”œâ”€â”€ Refresh Token
   â”‚   â””â”€â”€ ...
   â”œâ”€â”€ Users
   â”‚   â”œâ”€â”€ Get All Users
   â”‚   â”œâ”€â”€ Get User By ID
   â”‚   â””â”€â”€ ...
   â””â”€â”€ [Nuevas categorÃ­as segÃºn necesites]
   ```

4. **Variables de la colecciÃ³n**:
   - `base_url`: http://localhost:3000
   - `access_token`: Se actualiza automÃ¡ticamente
   - `refresh_token`: Se actualiza automÃ¡ticamente

5. **Ver documentaciÃ³n**: `docs/api/README.md`

## ğŸ“š DocumentaciÃ³n Adicional

- `docs/architecture.md` - DocumentaciÃ³n completa de arquitectura
- `docs/prisma/migrations.md` - GuÃ­a de migraciones
- `docs/auth/api-examples.md` - Ejemplos de API de autenticaciÃ³n
- `docs/api/README.md` - GuÃ­a de uso de la colecciÃ³n de Postman
- `README.md` - GuÃ­a de inicio rÃ¡pido

## ğŸ“§ Servicio de Email

El proyecto incluye un servicio de email usando Nodemailer:

- **ConfiguraciÃ³n**: `src/config/email.config.ts`
- **Servicio**: `src/services/Email.service.ts`
- **Variables de entorno**: `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS`, `EMAIL_FROM`, `EMAIL_FROM_NAME`, `APP_URL`

**Uso:**
```typescript
import { EmailService } from '../services/Email.service'
const emailService = new EmailService()
await emailService.sendPasswordResetEmail(email, token)
```

**En desarrollo sin SMTP configurado**: Los emails se imprimen en consola.

## âš ï¸ Importante

- **SIEMPRE** modifica `schema.prisma` antes de crear migraciones
- **NUNCA** edites manualmente archivos en `prisma/migrations/`
- **USA** `migrate deploy` en producciÃ³n, NO `migrate dev`
- **MANTÃ‰N** separaciÃ³n clara de responsabilidades entre capas
- **ACTUALIZA** la colecciÃ³n de Postman cuando agregues nuevas APIs

